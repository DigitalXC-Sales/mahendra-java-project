trigger:
  branches:
    include:
    - master

resources:
  repositories:
  - repository: mygithubrepo
    type: github
    name: DigitalXC-Sales/mahendra-java-project
    endpoint: DigitalXC-Sales

pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: Build
  displayName: 'Build Java Web App'
  jobs:
  - job: BuildJob
    steps:
    - checkout: mygithubrepo

    - task: Maven@4
      inputs:
        mavenPomFile: 'pom.xml'
        goals: 'clean package'
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '1.11'
        mavenVersionOption: 'Default'

    - task: CmdLine@2
      displayName: 'List Target Directory'
      inputs:
        script: |
          echo "Checking target folder contents:"
          ls -lR $(System.DefaultWorkingDirectory)/target

    - task: CopyFiles@2
      inputs:
        contents: '**/target/*.war'
        targetFolder: '$(Build.ArtifactStagingDirectory)'

    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)'
        artifactName: 'java-app'
        publishLocation: 'Container'

- stage: Deploy
  displayName: 'Deploy WAR to Tomcat'
  dependsOn: Build
  jobs:
  - job: DeployJob
    steps:
    - task: DownloadBuildArtifacts@0
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'java-app'
        downloadPath: '$(System.DefaultWorkingDirectory)'

    - task: CmdLine@2
      displayName: 'Deploy WAR to Tomcat'
      inputs:
        script: |
          echo "Deploying WAR to Tomcat Server..."
          WAR_FILE=$(find $(System.DefaultWorkingDirectory) -name "*.war")
          echo "WAR File Found: $WAR_FILE"

          curl -v -u "mahendra:Mahendra" --upload-file "$WAR_FILE" "http://localhost:8080/manager/text/deploy?path=/myapp&update=true"
